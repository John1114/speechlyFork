<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1'>

	<title>Speechly Web Toolkit and Browser-UI Beta</title>

  <link rel='icon' type='image/png' href='favicon.png'>
	<link rel='stylesheet' href='global.css'>
  <link rel="stylesheet" href="dev/speechly-ui.css">
 
  <!-- <script src="https://unpkg.com/@webcomponents/custom-elements"></script> -->
	<script src='dev/push-to-talk-button.js'></script>
	<script src='dev/big-transcript.js'></script>
</head>

<body>

  <div class="BigTranscriptContainer">
    <big-transcript></big-transcript>
  </div>

  <div class="PushToTalkContainer">
    <push-to-talk-button appid="ead4b9e7-e5c4-48ed-9dae-3c530916ed76"></push-to-talk-button>
  </div>

  <main>
    <h1>Speechly Web Toolkit and Browser-UI</h1>
    <h2>Quick installation from CDN</h2>
      Include the resources in your <code>&lt;head&gt;</code> block:
<xmp><head>
  <script type="text/javascript" src="https://speechly.github.io/browser-ui/dev/push-to-talk-button.js"></script>
  <script type="text/javascript" src="https://speechly.github.io/browser-ui/dev/big-transcript.js"></script>
  <link rel="stylesheet" href="https://speechly.github.io/browser-ui/speechly-ui.css">
</head>
</xmp>

    <h2>Usage</h2>
      <p>
        Include the following lines in your <code>&lt;body&gt;</code>:
      </p>
<xmp><div class="BigTranscriptContainer">
  <big-transcript></big-transcript>
</div> 
</xmp>

<xmp><div class="PushToTalkContainer">
  <push-to-talk-button appid="ead4b9e7-e5c4-48ed-9dae-3c530916ed76"></push-to-talk-button>
</div>
</xmp>

    <h2>Handling Speech Input</h2>
    Listen for the broadcasted speechsegment messages:
<xmp><script type="text/javascript">
  window.addEventListener("message", (e) => {
    if (e.data.type === "speechsegment") {
      const segment = e.data.segment;
      console.log("speechsegment message:", segment);
    }
  });
</script>
</xmp>
    
    <h2>Element &lt;push-to-talk-button/&gt;</h2>
    <p>
      Autonomous customElement for connecting to Speechly and controlling listening on/off.
    </p>
    <button onclick="hideButton()">Hide button</button> <button onclick="showButton()">Show button</button>

    <h3>Attributes</h3>
    <ul>
      <li>appid - Speechly App id to connect to.
      <li>poweron - Optional string "true" | "false". Shows poweron state. If false, recording can immediately start but will fail on first press due to system permission prompt. Default: "false" </li>
      <li>capturekey - Optional string (of length 1). Defines a keyboard hotkey that with control listening on/off. Default: undefined. Recommendation: Space (" ")</li>
      <li>size - Optional string (CSS). Defines the button frame width and height. Default: "6rem"</li>
      <li>hide - Optional "false" | "true". Default: "false"</li>
      <li>placement - Optional "bottom" turns on internal placement without PushToTalkContainer css class</li>
      <li>voffset - Optional CSS string. Vertical distance from viewport edge. Only effective when using placement.</li>
    </ul>
    <h3>Events emitted</h3>
    <ul>
      <li>holdstart - CustomEvent triggered upon hold start</li>
      <li>holdend - CustomEvent triggered upon hold end. event.detail.timeMs contains hold time in ms.</li>
	    <li>speechsegment - CustomEvent triggered when speech-to-text segment changes. Segment available as the event.details property.</li>
      <li>error - Details: Failed | NoBrowserSupport | NoAudioConsent</li>
    </ul>
    <h3>Window messages emitted</h3>
    <ul>
      <li>{type: "speechsegment", segment: {} as Segment} - Uses postMessage to broadcast new segment when an update is available</li>
    </ul>

    <h2>Element &lt;big-transcript/&gt;</h2>
    <p>
      <code>&lt;big-transcript/&gt;</code> is an overlay-style component for displaying real-time speech-to-text transcript.
    </p>
    <p>
      It is intended to be placed as an overlay near top-left corner of the screen using <code>BigTranscriptContainer</code> CSS class. It is momentarily displayed and automatically hidden after the end of voice input.
    </p>
    <button onclick="showTranscriptSample()">Show sample transcript</button>

    <h3>Attributes</h3>
    <ul>
      <li>placement - Optional "top" turns on internal placement without BigTranscriptContainer css class</li>
      <li>hoffset - Optional CSS string. Horizontal distance from viewport edge. Only effective when using placement.</li>
      <li>voffset - Optional CSS string. Vertical distance from viewport edge. Only effective when using placement.</li>
    </ul>

    <h3>Properties</h3>
    <ul>
      <li>onsegmentupdate(segment) - Call whenever a new segment update is available</li>
    </ul>
    <h3>Events listened</h3>
    <ul>
      <li>"speechsegment", {detail: {} as Segment} - Expect an update whenever a new segment update is available</li>
    </ul>
    <h3>Window messages listened</h3>
    <ul>
      <li>{type: "speechsegment", segment: {} as Segment} - Expects an update whenever a new segment update is available</li>
    </ul>

    <h2>Element &lt;holdable-button/&gt;</h2>
	  Autonomous customElement that displays a stateless, holdable button with an icon and emits events on press.
    <h3>Installation</h3>
<xmp><head>
  <script type="text/javascript" src="https://speechly.github.io/browser-ui/dev/holdable-button.js"></script>
</head>
</xmp>
    
    <h3>Attributes</h3>
    <ul>
      <li>icon - Defines the appearance and behaviour of the button. Accepts serialized enums of ClientState (from browser-client) or SpeechState (from react-client). SpeechState strings are: "Idle" | "Connecting" | "Ready" | "Recording" | "Loading" | "Failed" | "NoBrowserSupport" | "NoAudioConsent".</li>
      <li>capturekey - Optional string (of length 1). Defines a keyboard hotkey that with control listening on/off. Default: undefined. Recommendation: Space (" ")</li>
      <li>size - Optional string (CSS). Defines the button frame width and height. Default: "6rem"</li>
      <li>gradientstop1 - Optional string (CSS color). Default: "#15e8b5"
      <li>gradientstop2 - Optional string (CSS color). Default: "#4fa1f9"
    </ul>
    <h3>Callbacks</h3>
    <ul>
      <li>onholdstart - Called upon hold start.</li>
      <li>onholdend - Called hold end. Params: timeMs (number) contains hold time in ms.</li>
    </ul>
    <h3>Events emitted</h3>
    <ul>
      <li>holdstart - CustomEvent triggered upon hold start</li>
      <li>holdend - CustomEvent triggered upon hold end. event.detail.timeMs contains hold time in ms.</li>
    </ul>

    <h2>Browser-UI Playground Log</h2>
    <p>
      Try it out! Hold the button and talk.
      You can also try holding the hot key (SPACE) to activate listening.
    </p>
    <p>
      The listening hot key is disabled if an element like input has focus:<br/>
      <input type="text"/>
    </p>
    <pre><xmp id="info"></xmp></pre>
  </main>

	<script type="text/javascript">
    var webLogLines = "";
    webLog = (newLine) => {
      webLogLines += newLine + "\n";
      document.getElementById("info").innerHTML = webLogLines;
    }
    webLog("Start of index.html script V11...");
		const pushToTalkEl = document.getElementsByTagName("push-to-talk-button")[0];
    webLog("push-to-talk-button: "+pushToTalkEl);
		const transcriptEl = document.getElementsByTagName("big-transcript")[0];
    webLog("big-transcript: "+transcriptEl);

		pushToTalkEl.addEventListener("holdstart", (e) => {console.log("holdstart event received")});
		pushToTalkEl.addEventListener("holdend", (e) => {console.log("holdend event received", e.detail.timeMs)});
		window.addEventListener("message", (e) => {
      if (e.data.type === "speechsegment") {
        const segment = e.data.segment;
        console.log("speechsegment message:", segment);
        webLog(segment.words.map(w => w.value).join(" "));
        // transcriptEl.dispatchEvent(new CustomEvent("speechsegment", {detail: e.detail}));
        // window.postMessage({type: "speechsegment", segment: e.detail}, "*");
      }
    });

		pushToTalkEl.addEventListener("speechsegment", (e) => {
      const segment = e.detail;
      console.log("speechsegment event:", segment);
      // webLog(segment.words.map(w => w.value).join(" "));
      // transcriptEl.dispatchEvent(new CustomEvent("speechsegment", {detail: e.detail}));
      // window.postMessage({type: "speechsegment", segment: e.detail}, "*");
    });

		pushToTalkEl.addEventListener("error", (e) => {
      webLog(`error message received: ${e.detail}`)
      console.log(`error message received: ${e.detail}`)
    });
		transcriptEl.addEventListener("debug", (e) => {
      webLog(`${e.detail}`)
    });
    transcriptEl.dispatchEvent(new CustomEvent("ping", {detail: {msg: "test"}}));

    const showTranscriptSample = (e) => {
      const sampleSegment = {
        "id": 0,
        "contextId": "e310e11e-95d4-4f22-98dd-388a1bd84718",
        "isFinal": false,
        "words": [
            {
                "value": "TURN",
                "index": 2,
                "startTimestamp": 2040,
                "endTimestamp": 2640,
                "isFinal": true
            },
            {
                "value": "ON",
                "index": 3,
                "startTimestamp": 2640,
                "endTimestamp": 2820,
                "isFinal": true
            },
            {
                "value": "THE",
                "index": 4,
                "startTimestamp": 2820,
                "endTimestamp": 2940,
                "isFinal": true
            },
            {
                "value": "LIGHTS",
                "index": 5,
                "startTimestamp": 2940,
                "endTimestamp": 3420,
                "isFinal": true
            }
        ],
        "entities": [
            {
                "type": "email",
                "value": "thelights",
                "startPosition": 4,
                "endPosition": 6,
                "isFinal": true
            }
        ],
        "intent": {
            "intent": "email",
            "isFinal": true
        }
      }

      window.postMessage({type: "speechsegment", segment: sampleSegment}, "*");
    }

    const hideButton = (e) => {
      pushToTalkEl.setAttribute("hide", "true");
    }

    const showButton = (e) => {
      pushToTalkEl.setAttribute("hide", "false");
    }

    webLog("End of index.html script");
	</script>
</body>
</html>
